<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <title>{% block title %}InvPanel PRO{% endblock %}</title>

  <!-- PWA -->
  <link rel="manifest" href="/manifest.webmanifest">
  <meta name="theme-color" content="#0b1f33">
  <link rel="apple-touch-icon" href="/static/icons/icon-192.png">

  <style>
    :root{
      --bg:#0b1f33; --card:#ffffff; --muted:#6b7280; --border:#e5e7eb;
      --accent:#2563eb; --accent2:#0ea5e9; --danger:#ef4444;
      --text:#0f172a; --shadow:0 10px 25px rgba(0,0,0,.08);
      --radius:14px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; font-family:var(--font); background:linear-gradient(140deg,#061427,#0b1f33 60%, #0f2b46); color:var(--text); }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; padding-bottom:90px; }
    .topbar{ position:sticky; top:0; z-index:5; backdrop-filter: blur(12px); background:rgba(6,20,39,.7); border-bottom:1px solid rgba(255,255,255,.08); }
    .topbar .inner{ max-width:980px; margin:0 auto; padding:12px 18px; display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .brand{ display:flex; align-items:center; gap:10px; color:#fff; }
    .brand .logo{ width:32px; height:32px; border-radius:10px; background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow: 0 10px 20px rgba(37,99,235,.25); }
    .brand .title{ font-weight:800; letter-spacing:.2px; }
    .nav{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .nav a{ color:#e5e7eb; font-weight:600; font-size:14px; padding:8px 10px; border-radius:10px; }
    .nav a.active, .nav a:hover{ background:rgba(255,255,255,.10); }
    .nav form button:hover{ background:rgba(255,255,255,.10); }
    .pill{ display:inline-flex; align-items:center; gap:6px; }
    .badge{ display:inline-flex; align-items:center; justify-content:center; min-width:18px; height:18px; padding:0 6px; border-radius:999px; background:var(--danger); color:#fff; font-size:12px; font-weight:800; }

    .card{ background:rgba(255,255,255,.92); border:1px solid rgba(255,255,255,.6); box-shadow: var(--shadow); border-radius:var(--radius); padding:16px; margin:14px 0; }
    .muted{ color:var(--muted); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; border:1px solid var(--border); background:#fff; color:var(--text);
          padding:10px 12px; border-radius:12px; font-weight:800; cursor:pointer; }
    .btn:hover{ border-color:#cbd5e1; }
    .btn-primary{ background:linear-gradient(135deg,var(--accent),var(--accent2)); color:#fff; border:none; }
    .btn-secondary{ background:#f8fafc; }

    textarea, input, select{ width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid var(--border); background:#fff; font:inherit; }

    .flash{ padding:10px 12px; border-radius:12px; margin:10px 0; border:1px solid var(--border); background:#fff; }
    .flash.success{ border-color:rgba(16,185,129,.35); background:rgba(16,185,129,.10); }
    .flash.error{ border-color:rgba(239,68,68,.35); background:rgba(239,68,68,.08); }
    .flash.info{ border-color:rgba(59,130,246,.35); background:rgba(59,130,246,.10); }
    .flash.warning{ border-color:rgba(245,158,11,.40); background:rgba(245,158,11,.12); }

    /* Bottom nav (mobile) */
    .bottomnav{ position:fixed; bottom:0; left:0; right:0; z-index:10; background:rgba(6,20,39,.92); border-top:1px solid rgba(255,255,255,.10);
                padding:10px 10px 18px; }
    .bottomnav .inner{ max-width:980px; margin:0 auto; display:flex; justify-content:space-around; gap:10px; }
    .bottomnav a{ color:#e5e7eb; font-weight:800; font-size:12px; display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px 10px; border-radius:12px; }
    .bottomnav a.active{ background:rgba(255,255,255,.10); }

    @media(min-width:900px){
      .bottomnav{ display:none; }
      .wrap{ padding-bottom:22px; }
    }
  </style>

  {% block head_extra %}{% endblock %}
</head>
<body>

<header class="topbar">
  <div class="inner">
    <a class="brand" href="/">
      <span class="logo"></span>
      <span class="title">InvPanel PRO <span style="font-weight:700; font-size:12px; opacity:.8;">Rev 10</span></span>
    </a>

    <nav class="nav">
      {% if user.is_authenticated %}
        <a href="/" class="{% if request.path == '/' %}active{% endif %}">Panel</a>
        <a href="/portfolios/" class="{% if request.path|slice:':11' == '/portfolios' %}active{% endif %}">Portafolios</a>
        <a href="/assets/" class="{% if request.path|slice:':7' == '/assets' %}active{% endif %}">Activos</a>

        <a href="/opportunities/" class="pill {% if request.path|slice:':14' == '/opportunities' %}active{% endif %}">
          Oportunidades
          <span class="badge js-opps-badge" data-badge="opps" style="display:{% if nav_opps_count|default:0 > 0 %}inline-block{% else %}none{% endif %};">{{ nav_opps_count|default:"0" }}</span>
        </a>

        <a href="/analytics/" class="{% if request.path|slice:':10' == '/analytics' %}active{% endif %}">Análisis (PRO)</a>

        <a href="/manual/" class="{% if request.path|slice:':7' == '/manual' %}active{% endif %}">Manual</a>

        {% if user.is_staff %}
          <a href="/alerts/test/" class="{% if request.path|slice:':12' == '/alerts/test' %}active{% endif %}">Test mail</a>
        {% endif %}

        <form method="post" action="/logout/" style="display:inline; margin:0;">
          {% csrf_token %}
          <button type="submit" style="background:none; border:none; padding:8px 10px; border-radius:10px; color:#e5e7eb; font-weight:600; font-size:14px; cursor:pointer;">
            Salir
          </button>
        </form>
      {% else %}
        <a href="/login/" class="active">Ingresar</a>
      {% endif %}
    </nav>
  </div>
</header>

<main class="wrap">
  {% if messages %}
    {% for message in messages %}
      <div class="flash {% if message.tags %}{{ message.tags }}{% endif %}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  {% block content %}{% endblock %}
</main>

{% if user.is_authenticated %}
<footer class="bottomnav" aria-label="Navegación">
  <div class="inner">
    <a href="/" class="{% if request.path == '/' %}active{% endif %}">Panel</a>
    <a href="/portfolios/" class="{% if request.path|slice:':11' == '/portfolios' %}active{% endif %}">Portafolios</a>
    <a href="/opportunities/" class="pill {% if request.path|slice:':14' == '/opportunities' %}active{% endif %}">
      Oportunidades
      <span class="badge js-opps-badge" data-badge="opps" style="display:{% if nav_opps_count|default:0 > 0 %}inline-block{% else %}none{% endif %};">{{ nav_opps_count|default:"0" }}</span>
    </a>
    <a href="/analytics/" class="{% if request.path|slice:':10' == '/analytics' %}active{% endif %}">PRO</a>
    <a href="/manual/" class="{% if request.path|slice:':7' == '/manual' %}active{% endif %}">Manual</a>
  </div>
</footer>
{% endif %}

<script>
  // Register service worker for PWA + Push (safe no-op on unsupported browsers).
  (function(){
    try {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').then(function(reg){ try{ reg.update(); }catch(e){} }).catch(function(){});
      }
    } catch (e) { /* ignore */ }
  })();

  // App Badge (supported only on some platforms). Safe no-op when unavailable.
  // We set it from the server-side counter.
  (function(){
    try {
      const n = parseInt("{{ nav_app_badge|default:0 }}", 10) || 0;
      if ('setAppBadge' in navigator) {
        if (n > 0) navigator.setAppBadge(n);
        else if ('clearAppBadge' in navigator) navigator.clearAppBadge();
      }
    } catch (e) { /* ignore */ }
  })();

  // --- Live badges (sin recargar) ---
  (function () {
    const isAuth = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
    if (!isAuth) return;

    async function refreshBadges() {
      try {
        const res = await fetch("/api/badges/", { cache: "no-store", headers: { "X-Requested-With": "fetch" } });
        if (!res.ok) return;
        const data = await res.json();
        if (!data || !data.ok) return;

        const n = parseInt(data.opps_open || 0, 10) || 0;

        // actualizar todos los badges de oportunidades (header + footer)
        document.querySelectorAll(".js-opps-badge").forEach(function (el) {
          el.textContent = String(n);
          el.style.display = n > 0 ? "inline-block" : "none";
        });

        // (UX) También reflejar el contador en el título de la pestaña (útil en desktop)
        try {
          const baseTitle = "InvPanel PRO";
          if (n > 0) document.title = "(" + n + ") " + baseTitle;
          else document.title = baseTitle;
        } catch (e) {}

        // App Badge API (solo en navegadores/PWA que lo soporten)
        if ("setAppBadge" in navigator) {
          if (n > 0) {
            navigator.setAppBadge(n).catch(function () {});
          } else if ("clearAppBadge" in navigator) {
            navigator.clearAppBadge().catch(function () {});
          }
        }
      } catch (e) {
        // silencioso
      }
    }

    refreshBadges();
    setInterval(refreshBadges, 30000);
  })();

</script>

{% block body_extra %}{% endblock %}
</body>
</html>
